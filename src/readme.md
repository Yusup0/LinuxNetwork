# Сети в Linux

## Part 1. Инструмент ipcalc
### 1.1 Сети и маски
1) адрес сети 192.167.38.54/13  
   ![](./screenshot/1.1%201.png)
2)  перевод маски 255.255.255.0 в префиксную и двоичную запись
   ![](./screenshot/1.1%202.png)  
    /15 в обычную и двоичную  
   ![](./screenshot/1.1%203.png)  
    11111111.11111111.11111111.11110000 в обычную и префиксную  
   ![](./screenshot/1.1%204.png)  
3)  минимальный и максимальный хост в сети 12.167.38.4 при масках: /8,  
   ![](./screenshot/1.3%201.png)  
   11111111.11111111.00000000.00000000
   ![](./screenshot/1.3%202.png)  
    255.255.254.0   
   ![](./screenshot/1.3%203.png)  
    и /4  
   ![](./screenshot/1.3%204.png)  
   ### 1.2 localhost  
 * Можно обратиться 127.0.0.2, 127.1.0.1  
* Обраититься нельзя  194.34.23.100,  128.0.0.1  
### 1.3  Диапазоны и сегменты сетей
1.  
   * 10.0.0.45 частный
   * 134.43.0.2 публичный
   * 192.168.4.2 частный
   * 172.20.250.4 частный
   * 172.0.2.1 публичный
   * 192.172.0.1 публичный
   * 172.68.0.2 публичный
   * 172.16.255.255 частный
   * 10.10.10.10 частный
   * 192.169.168.1 публичный
2.  какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18:
    * 10.10.0.2
    * 10.10.10.10
    * 10.10.1.255  
## Part 2. Статическая маршрутизация между двумя машинами
 * С помощью команды ip посмотрим существующие сетевые интерфейсы  
   ws1  
   ![](./screenshot/2.0%201.png)   
   ws2  
   ![](./screenshot/2.0%202.png)  
* Сетевой интерфейс для ws1 и ws2 - enp0s3.
*  Зададим следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12 для:  
   ws1
   ![](./screenshot/2.0%203.png)  
   ws2  
   ![](./screenshot/2.0%204.png)  
  * Выполним команду netplan apply для перезапуска сервиса сети для:  
   ws1  
   ![](./screenshot/2.0%205.png)  
   ws2  
   ![](./screenshot/2.0%206.png) 
   ### 2.1. Добавление статического маршрута вручную
   * Добавим статический маршрут от одной машины до другой и обратно и пропингуем  
  ws1  
   ![](./screenshot/2.1%201.png)  
    ws2  
   ![](./screenshot/2.1%202.png)
### 2.2. Добавление статического маршрута с сохранением 
 * Добавим статический маршрут через netplan  
    ws1  
   ![](./screenshot/2.2%201.png)    
    ws2  
   ![](./screenshot/2.2%202.png)  
* Изменения сохраним командой netplan apply
* Пропингуем соединение между машинами  
   ws1  
   ![](./screenshot/2.2%203.png)    
    ws2  
   ![](./screenshot/2.2%204.png)  
## Part 3. Утилита iperf3
### 3.1 Скорость соединения  
*  8 Mbps в MB/s = 1 MB/s
*  100 MB/s в Kbps = 819 200 Kbps
*   1 Gbps в Mbps = 1024  Mbps
### 3.2. Утилита iperf3
* Для измерения скорости соединения между ws1 и ws2 запустим сервер на ws1 и подключится к нему через ws2  
ws1  
![](./screenshot/3.1.png)  
ws2  
![](./screenshot/3.1%202.png)  
## Part 4. Сетевой экран
### 4.1. Утилита iptables
* Фаил /etc/firewall.sh для:  
  ws1  
![](./screenshot/4.1%201.png)  
ws2  
![](./screenshot/4.1%202.png)
* Запуск обоих файлов   
  ws1  
![](./screenshot/4.1%203.png)  
ws2  
![](./screenshot/4.1%204.png)
* Разница межде стратегиями заключаеться в том, что первая запрешает передачу ICMP пакетов, в вторая нет.
### 4.2. Утилита nmap
* sw2 пингуеться   
![](./screenshot/4.2%201.png)
* sw1 не пингуеться, но находиться через nmap  
![](./screenshot/4.2%202.png)
## Part 5. Статическая маршрутизация сети
### 5.1. Настройка адресов машин
- Задаем стачисеские адреса машинам  
  ws11  
![](./screenshot/5.1%20ws11-1.png)  
  ws21  
![](./screenshot/5.1%20ws21-1.png)  
 ws22  
![](./screenshot/5-1%20sw22-1.png)  
r1  
![](./screenshot/5-1%20r1-1.png)  
r2  
![](./screenshot/5-1%20r2-1.png)  
- Обновляем настройки и проверяем IP  
  ws11  
![](./screenshot/5.1%20ws11-2.png)  
  ws21  
![](./screenshot/5.1%20ws21-2.png)  
 ws22  
![](./screenshot/5-1%20sw22-2.png)  
r1  
![](./screenshot/5-1%20r1-2.png)  
r2  
![](./screenshot/5-1%20r2-2.png)  
- Пингуем:
   ws22 с ws21  
![](./screenshot/5-1%20ping1.png)  
    r1 с ws11  
![](./screenshot/5-1%20ping2.png)
### 5.2 Включение переадресации IP-адресов.  
Для включения переадресации IP, выполним команду на роутерах  
![](./screenshot/5-2%201.png)  
Для включения переадресации IP, выполним команду на роутерах   на постоянной основе  
![](./screenshot/5-2%202.png)  
### 5.3. Установка маршрута по-умолчанию
- Настроим маршрут по-умолчанию (шлюз) для рабочих станций и покажем, что добавился маршрут в таблицу маршрутизации  
![](./screenshot/5-3%201.png)
- Пропингуем с ws11 роутер r2 и покажем на r2, что пинг доходи  
![](./screenshot/5-3%20ping.png)  
### 5.4. Добавление статических маршрутов
- Добавим в роутеры r1 и r2 статические маршруты и показажем таблицы с маршрутами на обоих роутерах  
![](./screenshot/5-4%201.png)  
- Запустим команды на ws11:
ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0  
![](./screenshot/5-4%202.png)  
- Для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, 
потому что есть маршрут который описывает ее лучше.

### 5.5. Построение списка маршрутизаторов
- Запустим на r1 команду дампа **tcpdump -tnv -i eth0** и при помощи утилиты traceroute пострим список маршрутизаторов на пути от ws11 до ws21  
![](./screenshot/5-5%201.png)  
![](./screenshot/5-5%202.png)  
 
 Для определения промежуточных маршрутизаторов traceroute отправляет целевому узлу серию ICMP-пакетов (по умолчанию 3 пакета), с каждым шагом увеличивая значение поля TTL («время жизни») на 1. Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первая серия пакетов отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно ICMP-сообщение «time exceeded in transit», указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку серии пакетов, но уже с TTL, равным 2, что заставляет первый маршрутизатор уменьшить TTL пакетов на единицу и направить их ко второму маршрутизатору. Второй маршрутизатор, получив пакеты с TTL=1, так же возвращает «time exceeded in transit».

Процесс повторяется до тех пор, пока пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.

На оконечном хосте IP-датаграмма с TTL = 1 не отбрасывается и не вызывает ICMP-сообщения типа срок истёк, а должна быть отдана приложению. Достижение пункта назначения определяется следующим образом: отсылаемые traceroute датаграммы содержат UDP-пакет с заведомо неиспользуемым номером порта на адресуемом хосте. Номер порта будет равен 33434 + (максимальное количество транзитных участков до узла) — 1. В пункте назначения UDP-модуль, получая подобные датаграммы, возвращает ICMP-сообщения об ошибке «порт недоступен». Таким образом, чтобы узнать о завершении работы, программе traceroute достаточно обнаружить, что поступило ICMP-сообщение об ошибке этого типа.

### 5.6. Использование протокола ICMP при маршрутизации 
- Запустим на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды **tcpdump -n -i eth0 icmp**
![](./screenshot/5-6%202.png)  
и пропингуем с ws11 несуществующий IP  
![](./screenshot/5-6%201.png)  
## Part 6. Динамическая настройка IP с помощью DHCP
- Начнем с настройки r1. В файле /etc/dhcp/dhcpd.conf пропишем необходимые конфигурации
![](./screenshot/6%202-1.png)  
 в файле resolv.conf пропишем **nameserver 8.8.8.8.**  
Перезагрузим службу DHCP командой **systemctl restart isc-dhcp-server**
Вернем дефортные насйтроки netplan машины ws21, перезагрузим ее  и через **ip a** покажем, что она получила адрес. Также пропингуем ws22 с ws21.
![](./screenshot/6%20ws21.png)
- Укажем MAC адрес у ws11  
![](./screenshot/6%20ws11.png)  
- Для r1 настроим аналогично r2, но сделаем выдачу адресов с жесткой привязкой к MAC-адресу (ws11).
![](./screenshot/6%20mac.png)   
![](./screenshot/6%20ip%20ws11.png)  
 - Запросить с ws21 обновление ip адреса  
![](./screenshot/6%20ip%20update.png) 
## Part 7. NAT
- В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80  
  r1
![](./screenshot/7.1%20r1.png)  
ws22   
![](./screenshot/7.1%20ws22.png)     
- Запустить веб-сервер Apache командой service apache2 start на ws22 и r1
![](./screenshot/7.2.png)     
- Добавить в фаервол удаление правил в таблице filter, удаление правил в таблице "NAT", отбрасывать все маршрутизируемые пакеты  
![](./screenshot/7.3%201.png)
Запустим файл       
![](./screenshot/7.3%202.png)  
Проверим соединение между ws22 и r1
![](./screenshot/7.3%203.png)  
- Разрешим маршрутизацию всех пакетов протокола ICMP
![](./screenshot/7.4%201.png)  
пропингуем  
![](./screenshot/7.4%202.png)  
-  включим SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 и  включим DNAT на 8080 порт машины r2 и добавим к веб-серверу Apache, запущенному на ws22, доступ извне сети
![](./screenshot/7.5%201.png)  
- Проверить соединение по TCP для SNAT и DNAT  
![](./screenshot/7.5%202.png)  
![](./screenshot/7.5%203.png)  
## Part 8. Дополнительно. Знакомство с SSH Tunnels
Запустим на r2 фаервол с правилами из Части 7
![](./screenshot/7.5%201.png)  

Запустим веб-сервер Apache на ws22 только на localhost

Получить доступ к веб-серверу на ws22 с ws21 через  Local TCP forwarding  
![](./screenshot/8.1.png)  

Воспользуемся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11  
![](./screenshot/8.3.png)  

Для проверки, сработало ли подключение в обоих предыдущих пунктах
![](./screenshot/8.2.png)  
![](./screenshot/8.2.png)  




  


